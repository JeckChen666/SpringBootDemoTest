<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web终端</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        .terminal-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .terminal-header {
            background-color: #333;
            padding: 10px;
            border-radius: 5px 5px 0 0;
            text-align: center;
        }
        .terminal-output {
            background-color: #000;
            border: 1px solid #333;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            white-space: pre-wrap;
            font-size: 14px;
        }
        .terminal-input {
            display: flex;
            background-color: #333;
            padding: 10px;
            border-radius: 0 0 5px 5px;
        }
        .terminal-prompt {
            color: #00ff00;
            margin-right: 10px;
        }
        #commandInput {
            flex: 1;
            background-color: transparent;
            border: none;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
        }
        .system-info {
            background-color: #2d2d2d;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .info-item {
            margin: 5px 0;
        }
        .success {
            color: #00ff00;
        }
        .error {
            color: #ff0000;
        }
        .command {
            color: #ffff00;
        }
    </style>
</head>
<body>
    <div class="terminal-container">
        <h1>Web终端模拟器</h1>
        
        <div class="system-info">
            <h3>系统信息</h3>
            <div id="systemInfo">加载中...</div>
        </div>
        
        <div class="terminal-header">
            <strong>终端输出</strong>
        </div>
        
        <div class="terminal-output" id="terminalOutput">
            欢迎使用Web终端！输入命令开始使用。\n
        </div>
        
        <div class="terminal-input">
            <span class="terminal-prompt">$</span>
            <input type="text" id="commandInput" placeholder="输入命令..." autofocus>
        </div>
    </div>

    <script>
        const terminalOutput = document.getElementById('terminalOutput');
        const commandInput = document.getElementById('commandInput');
        const systemInfo = document.getElementById('systemInfo');
        
        // 加载系统信息
        function loadSystemInfo() {
            fetch('/api/terminal/sysinfo')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        systemInfo.innerHTML = `
                            <div class="info-item"><strong>操作系统:</strong> ${data.osName} ${data.osVersion}</div>
                            <div class="info-item"><strong>系统架构:</strong> ${data.osArch}</div>
                            <div class="info-item"><strong>Java版本:</strong> ${data.javaVersion}</div>
                            <div class="info-item"><strong>用户目录:</strong> ${data.userHome}</div>
                            <div class="info-item"><strong>当前目录:</strong> ${data.userDir}</div>
                        `;
                    } else {
                        systemInfo.innerHTML = '<span class="error">加载系统信息失败</span>';
                    }
                })
                .catch(error => {
                    systemInfo.innerHTML = '<span class="error">加载系统信息失败: ' + error.message + '</span>';
                });
        }
        
        // 添加输出到终端
        function addOutput(text, className = '') {
            const span = document.createElement('span');
            span.textContent = text;
            if (className) {
                span.className = className;
            }
            terminalOutput.appendChild(span);
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }
        
        // 执行命令（使用SSE流式输出）
        function executeCommand(command) {
            if (!command.trim()) return;
            
            // 显示命令
            addOutput('$ ' + command + '\n', 'command');
            
            // 禁用输入框，防止重复执行
            commandInput.disabled = true;
            
            // 使用SSE接收流式数据
            fetch('/api/terminal/execute-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: command })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            // 流结束，重新启用输入框
                            commandInput.disabled = false;
                            commandInput.focus();
                            addOutput('\n');
                            return;
                        }
                        
                        // 解析SSE数据
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                if (data.trim()) {
                                    try {
                                        // 尝试解析JSON数据
                                        const jsonData = JSON.parse(data);
                                        if (jsonData.exitCode !== undefined) {
                                            // 命令结束
                                            const status = jsonData.success ? 'success' : 'error';
                                            addOutput(`\n[命令执行完成，退出码: ${jsonData.exitCode}]\n`, status);
                                        }
                                    } catch (e) {
                                        // 普通文本输出
                                        addOutput(data + '\n');
                                    }
                                }
                            } else if (line.startsWith('event: ')) {
                                const eventType = line.substring(7);
                                // 可以根据事件类型做不同处理
                            }
                        }
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                addOutput('网络错误: ' + error.message + '\n', 'error');
                addOutput('\n');
                commandInput.disabled = false;
                commandInput.focus();
            });
        }
        
        // 监听回车键
        commandInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const command = commandInput.value;
                commandInput.value = '';
                executeCommand(command);
            }
        });
        
        // 页面加载时获取系统信息
        window.onload = function() {
            loadSystemInfo();
        };
    </script>
</body>
</html>